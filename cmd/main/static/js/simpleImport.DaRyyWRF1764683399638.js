import{T as t,cy as e,f as n,ad as r,A as o,d7 as s}from"./three.BbguFgn81764683399638.js";import{F as i,_ as a,K as l,d as c}from"./@tresjs.CJvYCGUA1764683399638.js";import{g as u,i as p,e as d}from"./utils.DwLIMwCl1764683399638.js";import{J as m}from"./jszip.CqykFGTv1764683399638.js";import{F as f}from"./file-saver.Bli6IpKr1764683399638.js";import{P as v}from"./tweakpane.CqZAnw7f1764683399638.js";import{d as h,q as g,r as y,t as w,a3 as b,G as j,o as $,h as E,I as L,f as S,e as T,u as k,a9 as O,aa as P,ah as R,m as J,F as N}from"./@vue.DjQnunkc1764683399638.js";import{F as C}from"./@fesjs.CQdxRiFD1764683399638.js";import"./postprocessing.DjqPXL_K1764683399638.js";import"./@vueuse.BBrxj3Xz1764683399638.js";import"./@amap.fjyZdsU91764683399638.js";import"./vue-router.CW9J5iK31764683399638.js";import"./lodash-es.DWe8oqPO1764683399638.js";import"./pinia.yp40krTn1764683399638.js";import"./@qlin.y-0Z8WnK1764683399638.js";import"./@babel.BPq7uOAK1764683399638.js";import"./@floating-ui.Bhq4ibgf1764683399638.js";import"./@juggle.Vc7cP4_P1764683399638.js";function B(t,e){for(let n=0,r=t.length;n<r;n++)t[n](e)}window.THREE=t;const M={init:[],start:[],stop:[],keydown:[],keyup:[],pointerdown:[],pointerup:[],pointermove:[],update:[]},G=()=>{};function z(t){B(M.keydown,t)}function F(t){B(M.keyup,t)}function H(t){B(M.pointerdown,t)}function x(t){B(M.pointerup,t)}function W(t){B(M.pointermove,t)}let U=[];const K=(t,e,n,r,o)=>{e.childLevel;let s=`\n    <primitive :object="sceneObject.children[${r}]" name="${n.name}" uuid="${n.uuid}" type="${n.type}">\n    `;if(n.children&&n.children.length){const e=((t,e)=>{const n=t-1,r=["firstLevel","secondLevel","thirdLevel"],o=e.split("-").pop();return{fileName:`${r[n]}-${o}.vue`,comName:`${r[n]}${o}`}})(o,n.uuid);s+=`<${e.comName} :object="sceneObject.children[${r}].children" />`,((t,e,n)=>{let r="";n.forEach((t,e)=>{r+=`\n        <primitive :object="object[${e}]" name="${t.name}" uuid="${t.uuid}" type="${t.type}"/>\n        `});const o=`<template>\n    ${r}\n</template>\n\n<script setup lang="ts">\nconst props = withDefaults(\n    defineProps<{\n        object: any\n    }>(),\n    {},\n)\n<\/script>\n`;t.file(`${e.fileName}`,o),U.push(e)})(t,e,n.children)}return s+="\n    </primitive>\n",s},A=(t,e,n)=>{let r="";const o=t.folder("components/childComponent");return n.object&&n.object.children&&n.object.children.length&&n.object.children.forEach((t,n)=>{e.childLevel>0&&t.children&&t.children.length?r+=K(o,e,t,n,1):r+=`    \n    <primitive :object="sceneObject.children[${n}]" name="${t.name}" uuid="${t.uuid}" type="${t.type}"/>\n    `}),t.file("components/scene.vue",`<template>\n        ${r}</template>\n<script setup lang="ts">\nimport { onMounted } from 'vue'\nimport * as THREE from 'three'\nimport { loadImageToBase64, loadJsonFile } from 'PLS/tresEditor'\nimport { useTres, useLoop } from '@tresjs/core'\nimport player from '../common/eventScript'\n${(()=>{let t="";return U.forEach(e=>{t+=`import ${e.comName} from './childComponent/${e.fileName}'\n`}),t})()}\n\nconst { scene: tresScene, renderer, camera, sizes } = useTres()\nplayer.init(tresScene, renderer, camera, sizes)\n\nconst loader = new THREE.ObjectLoader()\nconst scene = await loadJsonFile('./plugins/${e.pluginName}/json/scene.json')\n\nif (scene.geometries) {\n    for (const geometry of scene.geometries) {\n        if (geometry.data && geometry.data.startsWith('url:')) {\n            let url = geometry.data.slice(4)\n            if (url.startsWith('geometries/')) {\n                url = \`./plugins/${e.pluginName}/\${url}\`\n            }\n            geometry.data = await loadJsonFile(url)\n        }\n    }\n}\nif (scene.images) {\n    for (const image of scene.images) {\n        if (image.url && image.url.startsWith('url:')) {\n            let url = image.url.slice(4)\n            if (url.startsWith('images/')) {\n                url = \`./plugins/${e.pluginName}/\${url}\`\n            }\n            if (url.endsWith(".json")) {\n                image.url = await loadJsonFile(url)\n            } else {\n                image.url = await loadImageToBase64(url)\n            }\n        }\n    }\n}\n\nconst sceneObject = loader.parse(scene) as any\nonMounted(() => {\n    tresScene.value.background = sceneObject.background\n    tresScene.value.environment = sceneObject.environment\n    tresScene.value.fog = sceneObject.fog\n    player.load(sceneObject)\n    player.play()\n})\nconst { onBeforeRender } = useLoop()\nonBeforeRender(({ delta, elapsed }) => {\n    if (player.renderer) {\n        player.render(elapsed * 1000, delta * 1000)\n    }\n})\n<\/script>`),"<Suspense>\n\t\t\t<sceneCom />\n\t\t</Suspense>"};function D(t,e){U=[];const n=e.pluginName,r=new m;((t,e)=>{const n=[];e.geometries&&e.geometries.forEach(t=>{"BufferGeometry"===t.type&&(n.push({uuid:t.uuid,data:t.data}),t.data=`url:geometries/${t.uuid}.json`)});const r=[];if(e.images&&e.images.forEach(t=>{t.url&&(r.push({uuid:t.uuid,url:t.url}),t.url.type?t.url=`url:images/${t.uuid}.${t.url.type}.json`:t.url=`url:images/${t.uuid}.${u(t.url)}`)}),n.length){const e=t.folder("geometries");n.forEach(t=>{e.file(`${t.uuid}.json`,JSON.stringify(t.data))})}if(r.length){const e=t.folder("images");r.forEach(t=>{t.url.type?e.file(`${t.uuid}.${t.url.type}.json`,JSON.stringify(t.url)):e.file(`${t.uuid}.${u(t.url)}`,t.url.split(";base64,").pop(),{base64:!0})})}t.file("json/scene.json",JSON.stringify(e))})(r.folder(`public/plugins/${n}`),t.scene);const o=r.folder(`src/plugins/${n}`);o.file("config.js",(t=>{const e=new Date,n=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`;return`\n\texport default {\n\t\t"name": "${t}",\n\t\t"title": "编辑器导出的插件",\n\t\t"intro": "描述",\n\t\t"version": "0.0.1",\n\t\t"author": "作者名",\n\t\t"website": "站点地址",\n\t\t"state": "active",\n\t\t"creatTime": "${n}",\n\t\t"updateTime": "${n}",\n\t\t"require": [],\n        "tvtstore": 'LOCAL',\n\t\t"preview": [\n\t\t\t{ "src": "plugins/basic/base/preview/theBasic.png", "type": "img", "name": "index", "title": "实例" ,"disableFPSGraph": false, "disableSrcBtn": false},\n\t\t]\n\t}`})(n));const s=((t,e,n,r)=>{const{uuid:o,...s}=n.object,i=JSON.parse(JSON.stringify(n));return i.object=s,`\n<template>\n    <loading />\n\t<TresCanvas v-bind="state">\n\t\t${r.orbitControls?"<OrbitControls />":""}\n\t\t${n?`<Tres${n.object.type}  ref="cameraRef" uuid="${n.object.uuid}" name="${n.object.name}" />`:""}\n\t\t${t}\n\t\t${r.gridHelper?"<TresGridHelper />":""}\n\t</TresCanvas>\n</template>\n<script setup lang="ts">\nimport * as THREE from 'three'\nimport { reactive, watch, ref } from 'vue'\nimport { TresCanvas } from '@tresjs/core'\nimport { OrbitControls } from '@tresjs/cientos'\nimport sceneCom from '../components/scene.vue'\nimport { loading2 as loading } from 'PLS/UIdemo'\n\nconst state = reactive({\n\tclearColor: '#201919',\n\twindowSize:true,\n\tantialias: true,\n\tshadows: ${e.shadows?"true":"false"},\n\tshadowMapType: ${e.shadowType?e.shadowType:"THREE.PCFShadowMap"},\n\ttoneMapping: ${e.toneMapping?e.toneMapping:"THREE.NoToneMapping"},\n\ttoneMappingExposure:${e.toneMappingExposure?e.toneMappingExposure:"1"},\n})\n\nconst cameraConfig = ${i?`${JSON.stringify(i)}`:"{}"}\nconst loader = new THREE.ObjectLoader()\nconst cameraObject = loader.parse(cameraConfig)\nconst cameraRef = ref(null)\nwatch(\n\t() => cameraRef.value,\n\t(val) => {\n\t\t\tval.copy(cameraObject)\n\t},\n)\n<\/script>\n\t`})(A(o,e,t.scene),t.project,t.camera,e);var i;return o.file("pages/index.vue",s),o.file("common/eventScript.js",(i=t.scripts,`/* eslint-disable prefer-rest-params */\n/* eslint-disable no-undefined */\n/* eslint-disable guard-for-in */\nimport * as THREE from 'three'\n\nwindow.THREE = THREE // Used by APP Scripts.\nconst Grscwh = { scene: null, renderer: null, camera: null, sizes: null }\nconst player = {\n\tget renderer() {\n\t\treturn Grscwh.renderer?.value\n\t},\n\tloader: new THREE.TextureLoader(),\n\tget scene() {\n\t\t\treturn Grscwh.scene?.value\n\t},\n\tget camera() {\n\t\t\treturn Grscwh.camera?.value\n\t},\n\tget width() {\n\t\t\treturn Grscwh.sizes?.width?.value\n\t},\n\tget height() {\n\t\t\treturn Grscwh.sizes?.height?.value\n\t},\n\tget dom() {\n\t\t\treturn Grscwh.renderer?.domElement.parentElement\n\t},\n\tget canvas() {\n\t\t\treturn Grscwh.renderer?.domElement\n\t},\n\tevents: {},\n\tinit(scene, renderer, camera, sizes) {\n\t\t\tGrscwh.scene = scene\n\t\t\tGrscwh.renderer = renderer\n\t\t\tGrscwh.camera = camera\n\t\t\tGrscwh.sizes = sizes\n\t},\n\tload(sceneObject) {\n\t\tconst scriptsJson = \n${JSON.stringify(i)}\n\n\t\tthis.events = {\n\t\t\t\tinit: [],\n\t\t\t\tstart: [],\n\t\t\t\tstop: [],\n\t\t\t\tkeydown: [],\n\t\t\t\tkeyup: [],\n\t\t\t\tpointerdown: [],\n\t\t\t\tpointerup: [],\n\t\t\t\tpointermove: [],\n\t\t\t\tupdate: [],\n\t\t}\n\t\tlet scriptWrapParams = 'player,renderer,scene,camera'\n\t\tconst scriptWrapResultObj = {}\n\n\t\tfor (const eventKey in this.events) {\n\t\t\t\tscriptWrapParams += \`,\${eventKey}\`\n\t\t\t\tscriptWrapResultObj[eventKey] = eventKey\n\t\t}\n\t\tconst scriptWrapResult = JSON.stringify(scriptWrapResultObj).replace(/\\"/g, '')\n\t\tfor (const uuid in scriptsJson) {\n\t\t\t\tlet curUuid = uuid\n\t\t\t\t//这里解决一个问题 目前并没有把 主场景scene直接替换而是通过group 加进入的，所以 如果事件是基于主场景scene 那么替换这个uuid为现在tres主场景的uuid\n\t\t\t\tif (uuid === sceneObject.uuid) {\n\t\t\t\t\t\tcurUuid = this.scene.uuid\n\t\t\t\t}\n\t\t\t\tconst object = this.scene.getObjectByProperty('uuid', curUuid, true)\n\t\t\t\tif (object === undefined) {\n\t\t\t\t\t\tconsole.warn('player: Script without object.', curUuid)\n\t\t\t\t\t\tcontinue\n\t\t\t\t}\n\t\t\t\tconst scripts = scriptsJson[uuid]\n\t\t\t\tfor (let i = 0; i < scripts.length; i++) {\n\t\t\t\t\t\tconst script = scripts[i]\n\t\t\t\t\t\t// eslint-disable-next-line no-new-func\n\t\t\t\t\t\tconst functions = new Function(scriptWrapParams, \`\${script.source}\nreturn \${scriptWrapResult};\`).bind(object)(\n\t\t\t\t\t\t\t\tthis,\n\t\t\t\t\t\t\t\tthis.renderer,\n\t\t\t\t\t\t\t\tthis.scene,\n\t\t\t\t\t\t\t\tthis.camera,\n\t\t\t\t\t\t)\n\t\t\t\t\t\tfor (const name in functions) {\n\t\t\t\t\t\t\t\tif (functions[name] === undefined) continue\n\t\t\t\t\t\t\t\tif (this.events[name] === undefined) {\n\t\t\t\t\t\t\t\t\t\tconsole.warn('player: Event type not supported (', name, ')')\n\t\t\t\t\t\t\t\t\t\tcontinue\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tthis.events[name].push(functions[name].bind(object))\n\t\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tthis.dispatch(this.events.init, arguments)\n\t\t}\n\t},\n\tdispatch(array, event) {\n\t\tfor (let i = 0, l = array.length; i < l; i++) {\n\t\t\t\tarray[i](event)\n\t\t}\n\t},\n\tsetCamera(value) {\n\t\t\tconsole.warn('暂时不考虑摄像机的设置函数', value)\n\t\t\t// camera = value\n\t\t\t// camera.aspect = this.width / this.height\n\t\t\t// camera.updateProjectionMatrix()\n\t},\n\tsetScene(value) {\n\t\t\tconsole.warn('暂时不考虑场景的设置函数', value)\n\t\t\t// scene = value\n\t},\n\tsetPixelRatio(value) {\n\t\t\tconsole.warn('暂时不考虑像素比的设置函数', value)\n\t},\n\tsetSize(value) {\n\t\t\tconsole.warn('暂时不考虑尺寸的设置函数', value)\n\t},\n\tdispose() {\n\t\t\t// renderer.dispose();\n\t\t\t// camera = undefined;\n\t\t\t// scene = undefined;\n\t\t\tconsole.warn('暂时不考虑释放资源的函数')\n\t},\n\tonKeyDown(event) {\n\t\tplayer.dispatch(player.events.keydown, event)\n\t},\n\tonKeyUp(event) {\n\t\t\tplayer.dispatch(player.events.keyup, event)\n\t},\n\tonPointerDown(event) {\n\t\t\tplayer.dispatch(player.events.pointerdown, event)\n\t},\n\tonPointerUp(event) {\n\t\t\tplayer.dispatch(player.events.pointerup, event)\n\t},\n\tonPointerMove(event) {\n\t\t\tplayer.dispatch(player.events.pointermove, event)\n\t},\n\tplay() {\n\t\t\tdocument.addEventListener('keydown', this.onKeyDown)\n\t\t\tdocument.addEventListener('keyup', this.onKeyUp)\n\t\t\tdocument.addEventListener('pointerdown', this.onPointerDown)\n\t\t\tdocument.addEventListener('pointerup', this.onPointerUp)\n\t\t\tdocument.addEventListener('pointermove', this.onPointerMove)\n\t\t\tthis.dispatch(this.events.start, null)\n\t\t\t//renderer.setAnimationLoop( animate ); 播放是自动的\n\t},\n\tstop() {\n\t\t\tdocument.removeEventListener('keydown', this.onKeyDown)\n\t\t\tdocument.removeEventListener('keyup', this.onKeyUp)\n\t\t\tdocument.removeEventListener('pointerdown', this.onPointerDown)\n\t\t\tdocument.removeEventListener('pointerup', this.onPointerUp)\n\t\t\tdocument.removeEventListener('pointermove', this.onPointerMove)\n\t\t\tthis.dispatch(this.events.stop, arguments)\n\t\t\t// renderer.setAnimationLoop( null );播放是自动的\n\t},\n\trender(elapsed, delta) {\n\t\t\tthis.dispatch(this.events.update, { time: elapsed, delta })\n\t},\n}\nexport default player\n`)),r.generateAsync({type:"blob"}).then(t=>{f.saveAs(t,`${n}.zip`)})}const I=h({__name:"importJson",setup(t){let r,o=null;var s=new e;let l=null;const{scene:c,renderer:u,camera:m,sizes:f}=i(),h=t=>{(()=>{if(!l)return;const t=e=>{let n=e.children.filter(t=>!!t);n.forEach(e=>{e.children.length?t(e):((t=>{t.geometry?.dispose(),t.material?.dispose()})(e),e.clear())}),e.clear(),n=null};t(l),l=null})(),document.removeEventListener("keydown",z),document.removeEventListener("keyup",F),document.removeEventListener("pointerdown",H),document.removeEventListener("pointerup",x),document.removeEventListener("pointermove",W),B(M.stop,null),M.init=[],M.start=[],M.stop=[],M.keydown=[],M.keyup=[],M.pointerdown=[],M.pointerup=[],M.pointermove=[],M.update=[],l=new n,t.children&&(l.children=t.children,c.value.add(l),c.value.background=t.background,c.value.environment=t.environment,c.value.fog=t.fog)},y=new v;y.addButton({title:"清空场景",label:"clear"}).on("click",()=>{confirm("确定要执行操作吗？")&&window.location.reload()});y.addButton({title:"导入原生场景Json",label:"srcJson"}).on("click",()=>{o?C.warning?.({content:"先清空场景",colorful:!0}):r&&(r.accept=".json",r.value=null,r.click())});const w=y.addFolder({title:"分解场景[中间件 测试用]",expanded:!1});w.addButton({title:"生成分解场景Zip",label:"Json2Zip"}).on("click",()=>{o?d(o):C.warning?.({content:"场景内无物体",colorful:!0})});w.addButton({title:"导入分解场景Zip",label:"Zip2Json"}).on("click",()=>{o?C.warning?.({content:"先清空场景",colorful:!0}):r&&(r.accept=".zip",r.value=null,r.click())});const b={orbitControls:!0,gridHelper:!0,pluginName:"testEditor",childLevel:1},j=y.addFolder({title:"TvT插件包"});j.addBinding(b,"pluginName",{label:"插件名称"}),j.addBinding(b,"orbitControls",{label:"默认控制器"}),j.addBinding(b,"gridHelper",{label:"默认网格"});j.addButton({title:"生成插件包",label:"MakePlugin"}).on("click",()=>{o?b.pluginName?D(o,b):C.warning?.({content:"请正确填写插件名称",colorful:!0}):C.warning?.({content:"场景内无物体",colorful:!0})});const $=t=>{o=t,h(s.parse(o.scene)),((t,e,n,r,o)=>{const s=o.scripts||{};let i="player,renderer,scene,camera";const a={};for(const c in M)i+=`,${c}`,a[c]=c;const l=JSON.stringify(a).replace(/\"/g,"");for(const c in s){let a=c;c===o.scene.object.uuid&&(a=e.uuid);const u=e.getObjectByProperty("uuid",a,!0);if(void 0===u){console.warn("APP.Player: Script without object.",a);continue}const p=s[c];for(let o=0;o<p.length;o++){const s=p[o],a=new Function(i,`${s.source}\nreturn ${l};`).bind(u)({width:r.width.value,height:r.height.value,setCamera:G},t,e,n);for(const t in a)void 0!==a[t]&&(void 0!==M[t]?M[t].push(a[t].bind(u)):console.warn("APP.Player: Event type not supported (",t,")"))}}B(M.init,null)})(u,c.value,m.value,f,o),document.addEventListener("keydown",z),document.addEventListener("keyup",F),document.addEventListener("pointerdown",H),document.addEventListener("pointerup",x),document.addEventListener("pointermove",W),B(M.start,null)};g(()=>{r=document.getElementById("fileInput"),r&&(r.onchange=t=>{const e=t.target.files[0];if(".json"===r.accept){const t=new FileReader;t.onload=t=>{const e=t.target.result;$(JSON.parse(e))},t.readAsText(e)}".zip"===r.accept&&p(e,$)})});const{onBeforeRender:E}=a();return E(({delta:t,elapsed:e})=>{((t,e)=>{B(M.update,{time:t,delta:e})})(1e3*e,1e3*t)}),(t,e)=>null}}),_=h({__name:"simpleImport",setup(t){const e=y({clearColor:"#201919",shadows:!0,alpha:!1,shadowMapType:s,outputColorSpace:o,toneMapping:r}),n=y({enableDamping:!0,dampingFactor:.05}),i=w(null);return b(()=>{i.value}),(t,r)=>($(),j(N,null,[E(k(c),J(e,{"window-size":""}),{default:S(()=>[r[0]||(r[0]=L("TresPerspectiveCamera",{position:[15,15,15],fov:45,near:.1,far:1e3,"look-at":[0,0,0]},null,-1)),E(k(l),O(P(n)),null,16),($(),T(R,null,{default:S(()=>[E(I)]),_:1})),r[1]||(r[1]=L("TresGridHelper",null,null,-1))]),_:1},16),r[2]||(r[2]=L("input",{id:"fileInput",type:"file",accept:".zip",style:{display:"none"}},null,-1))],64))}});export{_ as default};
