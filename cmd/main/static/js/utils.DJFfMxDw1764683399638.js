import{T as t,E as o}from"./@tweenjs.C9YEcV0Y1764683399638.js";import{l as e}from"./utils.e6kO7tRf1764683399638.js";import{M as a,B as n,S as s,V as r}from"./three.BbguFgn81764683399638.js";import{m as i}from"./d3-geo.C51lZA-81764683399638.js";const l=(e,a,n,s=1e3)=>{const r=e.value.position.clone(),i=n.value.target.clone(),l=a.clone(),c=a.clone();c.y=0;const u=new t({x:r.x,y:r.y,z:r.z,lookAtX:i.x,lookAtY:i.y,lookAtZ:i.z}).to({x:l.x,y:l.y,z:l.z,lookAtX:c.x,lookAtY:c.y,lookAtZ:c.z},s).easing(o.Quadratic.InOut).onUpdate(t=>{e.value.position.set(t.x,t.y,t.z),n.value.target.set(t.lookAtX,t.lookAtY,t.lookAtZ)}).start().onComplete(()=>{u.stop()});return u},c=(e,a,n,s=[-2e3,-2e3],r=1e3)=>{const i=e.position.clone(),l=n.target.clone(),c=a.clone(),u=a.clone();u.y=0,u.x=u.x+s[0],u.z=u.z+s[1];const p=new t({x:i.x,y:i.y,z:i.z,lookAtX:l.x,lookAtY:l.y,lookAtZ:l.z}).to({x:c.x,y:c.y,z:c.z,lookAtX:u.x,lookAtY:u.y,lookAtZ:u.z},r).easing(o.Quadratic.InOut).onUpdate(t=>{e.position.set(t.x,t.y,t.z),n.target.set(t.lookAtX,t.lookAtY,t.lookAtZ)}).start().onComplete(()=>{p.stop()});return p},u=async t=>{const o=await e(t),a=i().center(o[0].properties.center).translate([0,0]).scale(1e3),n=[];return o[0].geometry.coordinates[0].forEach(t=>{t.forEach(t=>{const[o,e]=a(t);n.push([o,0,e])})}),n},p=(t,o=!0,e=!0)=>{if(o||e){const n=new a;o&&n.multiply(t.userData.tilesData.rotationMatrix),e&&n.multiply(t.userData.tilesData.translationMatrix),t.matrixAutoUpdate=!1,t.matrix.identity(),t.matrix.copy(n)}else t.matrix.copy(t.userData.tilesData.initialMatrix);t.updateMatrixWorld(!0)},x=(t,o=!0,e=!0)=>{t.group.userData.tilesData={initialMatrix:t.group.matrix.clone()};const i=new n,l=new s,c=new r;if(t.getBoundingBox(i))i.getCenter(c);else{if(!t.getBoundingSphere(l))return void console.warn("tiles 没有 bounding 信息");c.copy(l.center)}const{east:u,north:x,up:y}=(t=>{const o=t.x,e=t.y;t.z;const a=Math.atan2(e,o),n=t.clone().normalize(),s=new r(-Math.sin(a),Math.cos(a),0),i=n.clone().multiplyScalar(s.dot(n));return s.sub(i).normalize(),{east:s,north:(new r).crossVectors(n,s).normalize(),up:n}})(c),m=(new a).makeBasis(u,x,y).clone().transpose();t.group.userData.tilesData.rotationMatrix=m.clone();const g=(new a).makeTranslation(-c.x,-c.y,-c.z);t.group.userData.tilesData.translationMatrix=g.clone(),p(t.group,o,e)},y=async t=>{if(!t.toLowerCase().endsWith(".json"))return!1;try{const o=await fetch(t);if(!o.ok)return!1;const e=await o.json(),a="object"==typeof e.asset&&void 0!==e.geometricError&&"object"==typeof e.root,n="1.0"===e.asset?.version||"1.1"===e.asset?.version;return a&&n}catch(o){return console.error("❌ 验证失败:",o),!1}};export{p as a,x as b,c,l as f,u as g,y as i};
