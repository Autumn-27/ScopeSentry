import{a2 as t,B as e,o as i,F as s,V as r,M as o,i as a,z as n,p as h,j as l,A as c,u as d,y as m,ah as p,m as u,d as f}from"./three.BbguFgn81764683399638.js";import{g,b as v,t as M}from"./@mapbox.DBNDgF_h1764683399638.js";import{c as w,d as x,a as y}from"./three-mesh-bvh.DQHx4kOk1764683399638.js";import{F as T}from"./Fetch.CIMEiaKn1764683399638.js";import{B as b}from"./three-custom-shader-material.VhylcSiy1764683399638.js";import{d as P,a as F,w as _,G as C,o as B,M as W}from"./@vue.DjQnunkc1764683399638.js";import{_ as j}from"./@fesjs.CQdxRiFD1764683399638.js";class k extends t{constructor(){super(),this.isDisposed=!1,this.isReady=!1,this.childrenTiles=[],this.boundingBoxWorld=new e}init(t,e,i){this.tileNo=t,Object.freeze(this.tileNo),this.map=e,this.parentTile=i,this.visible=!1,this.renderOrder=t[2],this.ready()}async ready(){if(this.content=await this.map.provider.getTile(this.tileNo),!this.isDisposed){if(this.add(this.content),this.boundingBoxWorld.setFromObject(this.content).applyMatrix4(this.matrixWorld.makeRotationX(-Math.PI/2)),this.map.add(this),this.visible=!0,this.isReady=!0,this.parentTile){const t=this.parentTile.childrenTiles;let e=0;for(let i=0;i<t.length;i++)t[i].isReady&&e++;4===e&&(this.parentTile.visible=!1)}this.update()}}update(){if(!this.isReady||this.isDisposed)return;const{cameraFrustum:t,cameraWorldPosition:e}=this.map;if(!t.intersectsBox(this.boundingBoxWorld))return void this.simplify();this.content instanceof i&&this.map.provider.filter&&(this.content.material.uniforms.t_Matrix.value=this.map.provider.getTranMatrix());let s=this.boundingBoxWorld.distanceToPoint(e);const r=this.tileNo[2];s/=Math.pow(2,this.map.provider.maxZoom-r),s<60&&this.subdivide(),s>80&&this.simplify();this.childrenTiles.sort((t,i)=>t.boundingBoxWorld.distanceToPoint(e)-i.boundingBoxWorld.distanceToPoint(e)).forEach(t=>t.update())}subdivide(){const{isReady:t,tileNo:e,map:i,childrenTiles:s}=this,r=e[2];if(!t||s.length>0||r>=i.maxZoom)return;g(e).forEach(t=>{const e=new k;e.init(t,i,this),s.push(e)})}simplify(){this.childrenTiles.forEach(t=>t.dispose()),this.childrenTiles=[],this.visible=!0}dispose(){this.map.remove(this),this.map.provider.abort(this.tileNo),this.childrenTiles.forEach(t=>t.dispose()),this.childrenTiles=[],this.parentTile=void 0,this.content&&(this.map.provider.dispose(this.tileNo,this.content),this.content=void 0),this.isDisposed=!0}}let U,I=class extends t{constructor(){super(),this.bbox=[74.390592,6.900905,134.071423,54.318199],this.maxZoom=20,this.rootForward=0,this.cameraFrustum=new s,this.cameraWorldPosition=new r,this.cameraProjectionMatrix=new o,this.lastCameraProjectionMatrix=new o,this.lastCameraWorldPosition=new r,this.rootTiles=[],this.lastUpdateTime=0,a.prototype.computeBoundsTree||(a.prototype.computeBoundsTree=w),a.prototype.disposeBoundsTree||(a.prototype.disposeBoundsTree=x),i.prototype.raycast=y}initRootTiles(){this.rootForward>3&&(console.warn("rootForward needs to be 0 - 3."),this.rootForward=3),this.rootForward<0&&(console.warn("rootForward needs to be 0 - 3."),this.rootForward=0);const t=[];let e=[v(this.bbox)],i=this.rootForward;for(;i>0;){const t=[...e];e=[],t.forEach(t=>{const i=g(t);e.push(...i)}),i--}t.push(...e),t.forEach(t=>{const e=new k;e.init(t,this),this.rootTiles.push(e)})}update(){if(!this.visible||!this.camera)return;const t=Date.now();t-this.lastUpdateTime<300||(0!==this.rootTiles.length?(this.camera.getWorldPosition(this.cameraWorldPosition),this.cameraProjectionMatrix.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),this.cameraWorldPosition.equals(this.lastCameraWorldPosition)&&this.cameraProjectionMatrix.equals(this.lastCameraProjectionMatrix)||(this.cameraFrustum.setFromProjectionMatrix(this.cameraProjectionMatrix),this.rootTiles.forEach(t=>t.update()),this.lastCameraProjectionMatrix.copy(this.cameraProjectionMatrix),this.lastCameraWorldPosition.copy(this.cameraWorldPosition),this.lastUpdateTime=t)):this.initRootTiles())}dispose(){throw new Error("[Map.dispose] Method not implemented.")}regenerate(){throw new Error("[Map.regenerate] Method not implemented.")}};class S{constructor(t){this.terminated=!0,this.map=new Map,this.worker=new t,this.worker.onmessage=this.onMessage.bind(this),this.terminated=!1}async postMessage(t){if(!this.terminated)return this.worker.postMessage(t),new Promise((e,i)=>{this.map.set(t.id,e)})}onMessage(t){const{id:e,error:i}=t.data,s=this.map.get(e);s&&!i&&s(t.data),this.map.delete(e)}terminate(){this.worker.onmessage=null,this.worker.terminate(),this.terminated=!0,this.map.clear()}}function R(t){return new Worker(""+new URL("../static/MapWorker-BP068Z4Y.js",import.meta.url).href,{name:t?.name})}class E{constructor(){this.maxZoom=20,this.source="https://gac-geo.googlecnapps.cn/maps/vt?lyrs=s&x=[x]&y=[y]&z=[z]",this.showTileNo=!1,this._useWorker=!1,this.fetching=new Map}set useWorker(t){this._useWorker=t,this._useWorker||(this._worker?.terminate(),this._worker=void 0)}get useWorker(){return this._useWorker}async getTile(t){const e=this.getUrl(t),i=new n;if(this._useWorker){this._worker||(this._worker=new S(R));const s=this.getId(t),r=await this._worker.postMessage({id:s,tileNo:t,url:e,debug:this.showTileNo});i.image=r.bitmap}else{const s=new T(e,{cache:"force-cache",mode:"cors"});this.fetching.set(t,s);try{i.image=await async function(t,e,i=!1){const s=await e.ready(),r=await s.blob(),o=await createImageBitmap(r,i?void 0:{imageOrientation:"flipY"});if(!i)return o;U||(U=new OffscreenCanvas(256,256));const a=U.getContext("2d");if(!a)throw new Error('Offscreencanvas.getContext("2d") error!');const{width:n,height:h}=U;return a.drawImage(o,0,0),a.rect(0,0,n,h),a.strokeStyle="#00FFFF",a.font="20px Arial",a.stroke(),a.fillStyle="#FF4444",a.fillText(`${t[0]}`,10,30),a.fillStyle="#44FF44",a.fillText(`${t[1]}`,10,55),a.fillStyle="#66AAFF",a.fillText(`${t[2]}`,10,80),await createImageBitmap(U,{imageOrientation:"flipY"})}(t,s,this.showTileNo)}finally{this.fetching.delete(t)}}return i.needsUpdate=!0,i.anisotropy=4,i}abort(t){if(this._useWorker)this._worker?.postMessage({id:this.getId(t),abort:!0});else{const e=this.fetching.get(t);e&&e.abort(),this.fetching.delete(t)}}dispose(t,e){e.dispose()}getId(t){return t.join("-")}getUrl(t){const[e,i,s]=t;return-1===this.source.indexOf("[x]")?this.source.replace("{x}",e+"").replace("{y}",i+"").replace("{z}",s+""):this.source.replace("[x]",e+"").replace("[y]",i+"").replace("[z]",s+"")}}const q="utm",N="merc",D=6378137,O=Math.PI/180;function X(t,e){return[D*t*O,D*Math.log(Math.tan(.25*Math.PI+e*O*.5))]}function z(t){return t*Math.PI/180}function Z(t){return 180*t/Math.PI}const A={a:6378137,f:1/298.257223563};function G(t,e,i){if(!(-80<=e&&e<=84))throw new RangeError(`latitude ‘${e}’ outside UTM limits`);let s=i||Math.floor((t+180)/6)+1,r=z(6*(s-1)-180+3);const o="CDEFGHJKLMNPQRSTUVWXX".charAt(Math.floor(e/8+10));31===s&&"V"===o&&t>=3?(s++,r+=z(6)):32===s&&"X"===o&&t<9?(s--,r-=z(6)):32===s&&"X"===o&&t>=9?(s++,r+=z(6)):34===s&&"X"===o&&t<21?(s--,r-=z(6)):34===s&&"X"===o&&t>=21?(s++,r+=z(6)):36===s&&"X"===o&&t<33?(s--,r-=z(6)):36===s&&"X"===o&&t>=33&&(s++,r+=z(6));const a=z(e),n=z(t)-r,{a:h,f:l}=A,c=.9996,d=Math.sqrt(l*(2-l)),m=l/(2-l),p=m*m,u=m*p,f=m*u,g=m*f,v=m*g,M=Math.cos(n),w=Math.sin(n),x=Math.tan(a),y=Math.sinh(d*Math.atanh(d*x/Math.sqrt(1+x*x))),T=x*Math.sqrt(1+y*y)-y*Math.sqrt(1+x*x),b=Math.atan2(T,M),P=Math.asinh(w/Math.sqrt(T*T+M*M)),F=h/(1+m)*(1+1/4*p+1/64*f+1/256*v),_=[null,.5*m-2/3*p+5/16*u+41/180*f-127/288*g+7891/37800*v,13/48*p-.6*u+557/1440*f+281/630*g-1983433/1935360*v,61/240*u-103/140*f+15061/26880*g+167603/181440*v,49561/161280*f-179/168*g+6601661/7257600*v,34729/80640*g-3418889/1995840*v,.6650675310896665*v];let C=b;for(let k=1;k<=6;k++)C+=_[k]*Math.sin(2*k*b)*Math.cosh(2*k*P);let B=P;for(let k=1;k<=6;k++)B+=_[k]*Math.cos(2*k*b)*Math.sinh(2*k*P);let W=c*F*B,j=c*F*C;return W+=5e5,j<0&&(j+=1e7),[W,j]}class L{constructor(){this.utmZone=50,this.coordType=q,this.maxZoom=20}async getTile(t){const e=new h,i=M(t),s=this.convertCoordinate(i[0],i[3]),r=this.convertCoordinate(i[2],i[3]),o=this.convertCoordinate(i[0],i[1]),a=this.convertCoordinate(i[2],i[1]),n=new Float32Array([s[0],s[1],0,r[0],r[1],0,o[0],o[1],0,a[0],a[1],0]);return e.setAttribute("position",new l(n,3)),e}abort(t){}dispose(t,e){e.dispose()}convertCoordinate(t,e){return this.coordType===q?G(t,e,this.utmZone):X(t,e)}}class V extends i{constructor(t){super(t),this.center=new r}}class Y{constructor(t,e){this.geometryProvider=t,this.textureProvider=e,this.maxZoom=20,this.showBoundingBox=!1,this.wireframe=!1,this.flatShading=!1,this.useStandardMaterial=!1,this.filter=null}getTranMatrix(){let t=new o;if(this.filter?.opposite){let e=new o;e.set(-1,0,0,0,0,-1,0,0,0,0,-1,0,1,1,1,1),t.multiply(e)}if(this.filter?.monochrome){let e=new o;const i=this.filter.monochrome.r,s=this.filter.monochrome.g,r=this.filter.monochrome.b;e.set(i,s,r,0,i,s,r,0,i,s,r,0,0,0,0,1),t.multiply(e)}if(this.filter?.genBright){let e=new o;const i=this.filter.genBright;e.set(i,0,0,0,0,i,0,0,0,0,i,0,0,0,0,1),t.multiply(e)}if(this.filter?.genContrast){let e=new o;const i=this.filter.genContrast,s=.5*(1-i);e.set(i,0,0,0,0,i,0,0,0,0,i,0,s,s,s,1),t.multiply(e)}if(this.filter?.genSaturate){let e=new o;const i=this.filter.genSaturate,s=.3*(1-i),r=.6*(1-i),a=.1*(1-i);e.set(s+i,s,s,0,r,r+i,r,0,a,a,a+i,0,0,0,0,1),t.multiply(e)}return t}async getTile(t){const e=[this.geometryProvider.getTile(t),this.textureProvider.getTile(t)],i=await Promise.all(e),s=i[0],r=i[1];r.colorSpace=c;const{wireframe:o,flatShading:a}=this;let n=null;const h=t[0]+t[1]+t[2];n=this.useStandardMaterial?new d({map:r,wireframe:o,flatShading:a}):new m({map:r,wireframe:o}),this.filter&&(n=new b({baseMaterial:n,vertexShader:"\n                varying vec2 vUv;    //顶点纹理坐标\n                void main () {\n                    vUv = uv;\n                    // gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4( position, 1.0 ); 着色器会抖动\n                    // gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n                    csm_Position = position * vec3(1.0);\n                }\n                ",fragmentShader:"\n                uniform sampler2D e_Texture;     //纹理图像\n                varying vec2 vUv;               //片元纹理坐标\n                uniform mat4 t_Matrix;     //接收变换矩阵\n                void main () {\n                    // gl_FragColor = texture2D( e_Texture, vUv );\n\n                    // vec4 textureColor = texture2D( e_Texture, vUv );\n                    // //计算加权平均值\n                    // float w_a = textureColor.r * 0.3 + textureColor.g * 0.6 + textureColor.b * 0.1;\n                    // gl_FragColor = vec4(w_a, w_a, w_a, 1.0);\n\n                    vec4 textureColor = texture2D( e_Texture, vUv );\n                    //变换矩阵乘以 vec4(R,G,B,1)    ---\x3evec4(R,G,B,1) 是齐次坐标，原本是n维的向量用一个n+1维向量来表示\n                    //vec4(R,G,B,1)第四个分量不是透明度\n                    vec4 transColor =  vec4(textureColor.r, textureColor.g, textureColor.b, 1.0)*t_Matrix; \n                    //设置透明度\n                    transColor.a = 1.0;\n                    csm_FragColor = transColor;\n\n                    // if(vUv.x==0.0 || vUv.x==1.0 || vUv.y==0.0 || vUv.y==1.0){\n                    //     gl_FragColor.a = 0.0;\n                    // }\n                }",silent:!0,flatShading:a,uniforms:{e_Texture:{value:r},t_Matrix:{value:this.getTranMatrix()}}}));const l=new V;if(l.renderOrder=h,s.computeBoundingBox(),s.boundingBox.getCenter(l.center),s.center(),s.computeBoundingSphere(),s.computeBoundsTree(),l.position.copy(l.center),l.geometry=s,l.material=n,this.showBoundingBox){const t=new p(s.boundingBox);l.add(t)}return l}abort(t){this.geometryProvider.abort(t),this.textureProvider.abort(t)}dispose(t,e){const i=e.geometry,s=e.material;i&&this.geometryProvider.dispose(t,i),s&&s.map&&this.textureProvider.dispose(t,s.map),s?.dispose()}}const $={class:"lonLatDiv"},H=j(P({__name:"raycasterEvent",props:{tileMapRef:{}},setup(t){const e=t,i=F([0,0]);return _(()=>e.tileMapRef,(t,e)=>{if(!e&&t){let e=function(e){r.x=e.clientX/window.innerWidth*2-1,r.y=-e.clientY/window.innerHeight*2+1,s.setFromCamera(r,t.camera);var o=s.intersectObjects(t.map.children);if(o.length>0){var a=o[0];t.map.provider.geometryProvider.coordType===q?i.value=function(t,e){const{a:i,f:s}=A,r=.9996,o=t-5e5,a=e,n=Math.sqrt(s*(2-s)),h=s/(2-s),l=h*h,c=h*l,d=h*c,m=h*d,p=h*m,u=i/(1+h)*(1+1/4*l+1/64*d+1/256*p),f=o/(r*u),g=a/(r*u),v=[null,.5*h-2/3*l+37/96*c-1/360*d-81/512*m+96199/604800*p,1/48*l+1/15*c-437/1440*d+46/105*m-1118711/3870720*p,17/480*c-37/840*d-209/4480*m+5569/90720*p,4397/161280*d-11/504*m-830251/7257600*p,4583/161280*m-108847/3991680*p,20648693/638668800*p];let M=g;for(let j=1;j<=6;j++)M-=v[j]*Math.sin(2*j*g)*Math.cosh(2*j*f);let w=f;for(let j=1;j<=6;j++)w-=v[j]*Math.cos(2*j*g)*Math.sinh(2*j*f);const x=Math.sinh(w),y=Math.sin(M),T=Math.cos(M),b=y/Math.sqrt(x*x+T*T);let P=null,F=b;do{const t=Math.sinh(n*Math.atanh(n*F/Math.sqrt(1+F*F))),e=F*Math.sqrt(1+t*t)-t*Math.sqrt(1+F*F);P=(b-e)/Math.sqrt(1+e*e)*(1+(1-n*n)*F*F)/((1-n*n)*Math.sqrt(1+F*F)),F+=P}while(Math.abs(P)>1e-12);const _=F,C=Math.atan(_);let B=Math.atan2(x,T);B+=z(117);const W=Number(Z(C).toFixed(14));return[Number(Z(B).toFixed(14)),W]}(a.point.x,-a.point.z):i.value=function(t,e){let i=t/(D*Math.PI)*180,s=e/(D*Math.PI)*180;return s=180/Math.PI*(2*Math.atan(Math.exp(s*Math.PI/180))-Math.PI/2),[i,s]}(a.point.x,-a.point.z),i.value[0]=i.value[0].toFixed(4),i.value[1]=i.value[1].toFixed(4)}};console.log("raycasterEvent:",t);var s=new u,r=new f;document.addEventListener("mousemove",e,!1)}}),(t,e)=>(B(),C("div",$," lon:"+W(i.value[0])+" lat:"+W(i.value[1]),1))}}),[["__scopeId","data-v-dec4ba56"]]);export{N as M,S as P,Y as T,q as U,L as a,E as b,I as c,G as d,X as l,H as r};
