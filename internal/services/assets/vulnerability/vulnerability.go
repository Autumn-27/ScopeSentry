package vulnerability

import (
	"context"
	"fmt"

	"github.com/Autumn-27/ScopeSentry-go/internal/utils/helper"

	"github.com/Autumn-27/ScopeSentry-go/internal/models"
	"github.com/Autumn-27/ScopeSentry-go/internal/repositories/assets/vulnerability"
	"github.com/gin-gonic/gin"
	"go.mongodb.org/mongo-driver/bson"
	"go.mongodb.org/mongo-driver/mongo/options"
)

type Service interface {
	GetVulnerabilities(ctx context.Context, query models.SearchRequest) (models.VulnerabilityResponse, error)
	GetVulnerabilityDetailByHash(ctx *gin.Context, hash string) (*models.VulnerabilityDetail, error)
}

type service struct {
	repo vulnerability.Repository
}

func NewService() Service {
	return &service{
		repo: vulnerability.NewRepository(),
	}
}

func (s *service) GetVulnerabilities(ctx context.Context, query models.SearchRequest) (models.VulnerabilityResponse, error) {
	query.Index = "vulnerability"
	searchQuery, err := helper.GetSearchQuery(query)
	if err != nil {
		return models.VulnerabilityResponse{}, err
	}
	filter := bson.M(searchQuery)
	totalCount, err := s.repo.CountDocuments(ctx, filter)
	var result models.VulnerabilityResponse
	if err != nil {
		return result, fmt.Errorf("failed to count documents: %w", err)
	}
	result.Total = totalCount
	if totalCount == 0 {
		return result, nil
	}
	sort := bson.D{
		{
			Key: "time", Value: -1,
		},
	}
	opts := options.Find().
		SetSkip(int64((query.PageIndex - 1) * query.PageSize)).
		SetLimit(int64(query.PageSize)).SetSort(sort)
	res, err := s.repo.Find(ctx, filter, opts)
	if err != nil {
		return result, err
	}
	result.List = res
	return result, nil
}

func (s *service) GetVulnerabilityDetailByHash(ctx *gin.Context, hash string) (*models.VulnerabilityDetail, error) {
	detail, err := s.repo.FindDetailByHash(ctx.Request.Context(), hash)
	if err != nil {
		return nil, fmt.Errorf("failed to find vulnerability detail: %w", err)
	}
	return detail, nil
}
